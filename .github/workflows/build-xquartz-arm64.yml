name: Build XQuartz (macOS arm64)

on:
  workflow_dispatch:

jobs:
  build-xquartz:
    runs-on: macos-14

    env:
      PREFIX: ${{ runner.temp }}/opt/X11
      BUILD_DIR: ${{ runner.temp }}/build
      HOMEBREW_NO_AUTO_UPDATE: 1
      HOMEBREW_NO_INSTALL_CLEANUP: 1
      MESON_ARGS: >-
        -Dxquartz=true
        -Dxorg=false
        -Dxnest=false
        -Dxvfb=false
        -Dglx=false
        -Dwerror=false
        -Dstrip=true
        -Dtests=false
        -Dapple-applications-dir=${{ runner.temp }}/opt/X11/Applications
        -Dapple-application-name=XQuartz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew install autoconf automake libtool pkg-config \
            meson ninja pixman freetype fontconfig \
            libxcb xcb-util xcb-util-image xcb-util-wm \
            xorgproto libX11 libXext libXdmcp glib \
            libepoxy

      - name: Prepare build directory
        run: |
          mkdir -p "$BUILD_DIR"
          mkdir -p "$PREFIX"

      - name: Build xserver (Quartz backend)
        run: |
          meson setup "$BUILD_DIR" $MESON_ARGS --prefix="$PREFIX" --buildtype=release
          meson compile -C "$BUILD_DIR" -j$(sysctl -n hw.logicalcpu)
          meson install -C "$BUILD_DIR"

      - name: Archive /opt/X11 runtime
        uses: actions/upload-artifact@v4
        with:
          name: opt-X11-runtime
          path: ${{ env.PREFIX }}

      - name: Archive XQuartz CLI
        uses: actions/upload-artifact@v4
        with:
          name: xquartz-cli
          path: ${{ env.PREFIX }}/bin/Xquartz

      - name: Archive XQuartz.app bundle
        uses: actions/upload-artifact@v4
        with:
          name: xquartz-app
          path: ${{ env.PREFIX }}/Applications/XQuartz.app
