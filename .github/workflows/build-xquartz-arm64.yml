name: Build XQuartz (macOS arm64)

permissions:
  contents: write

env:
  MESON_BUILDDIR: build
  X11_PREFIX: /Users/runner/x11
  X11_BUILD_DIR: /Users/runner/build-deps

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  xquartz-arm64:
    runs-on: macos-14
    env:
      # 和 X11Libre 官方的 xserver-build-macos 一致，只控制前缀和少数开关
      MESON_ARGS: >-
        -Dprefix=/tmp
        -Dglx=false
        -Dxnest=false
        -Dxfbdev=false

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Prepare build environment
        run: |
          echo "PKG_CONFIG_PATH=${X11_PREFIX}/share/pkgconfig:${X11_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}" >> "$GITHUB_ENV"

      - name: Homebrew cache
        uses: actions/cache@v4
        with:
          path: /Users/runner/Library/Caches/Homebrew
          key: ${{ runner.os }}-homebrew-cache-${{ hashFiles('.github/scripts/macos/install-pkg.sh') }}
          restore-keys: ${{ runner.os }}-homebrew-cache-

      - name: Install packages (brew)
        run: .github/scripts/macos/install-pkg.sh

      - name: X11 prereq cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.X11_PREFIX }}
            ${{ env.X11_BUILD_DIR }}/xts
            ${{ env.X11_BUILD_DIR }}/piglit
          key: ${{ runner.os }}-x11-deps-${{ hashFiles('.github/scripts/install-prereq.sh') }}
          restore-keys: ${{ runner.os }}-x11-deps-

      - name: Build X11 prereqs (proto/libs)
        run: .github/scripts/install-prereq.sh

      # 关键：用官方的 meson-build.sh 来跑 meson setup/compile
      - name: Build XQuartz (meson-build.sh)
        run: |
          .gitlab-ci/meson-build.sh

      # 跟官方 macOS job 类似的测试步骤，可选
      - name: Tests (may fail)
        continue-on-error: true
        run: |
          meson test -C "${MESON_BUILDDIR}" --print-errorlogs -j1 || true
        env:
          XTEST_DIR:  ${{ env.X11_BUILD_DIR }}/xts
          PIGLIT_DIR: ${{ env.X11_BUILD_DIR }}/piglit

      - name: Archive build logs
        uses: actions/upload-artifact@v4
        with:
          name: xquartz-macos-arm64-logs
          path: |
            build/meson-logs/*
            build/test/piglit-results/*

      # 直接上传 XQuartz 可执行文件（配合你本地替换 /Applications 里的 X11）
      - name: Upload XQuartz binary
        uses: actions/upload-artifact@v4
        with:
          name: xquartz-macos-arm64-bin
          path: |
            build/hw/xquartz/mach-startup/Xquartz

      # 用 DESTDIR 安装到临时 staging 目录，前缀是 /tmp，对应 stage/tmp
      - name: Install to staging with DESTDIR
        run: |
          mkdir -p "$PWD/stage"
          DESTDIR="$PWD/stage" meson install -C "${MESON_BUILDDIR}"

      # 把 stage 下的 /tmp/X11 重新整理成 /opt/X11 目录树
      - name: Assemble /opt tree from staged install
        run: |
          PKG_DIR="$PWD/opt-package"
          mkdir -p "$PKG_DIR/opt"
          rm -rf "$PKG_DIR/opt/X11"
          mv "$PWD/stage/tmp" "$PKG_DIR/opt/X11"

      - name: Archive /opt runtime tree
        uses: actions/upload-artifact@v4
        with:
          name: opt-X11-runtime
          path: |
            opt-package/opt
